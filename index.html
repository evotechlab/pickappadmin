<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WMS - Admin Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body{
    margin:0;
    font-family:Inter,sans-serif;
    background:#f1f5f9;
    color:#0f172a;
}

header{
    background:#0f172a;
    color:white;
    padding:18px;
    text-align:center;
    font-weight:600;
    font-size:18px;
}

.container{
    padding:20px;
}

/* KPI CARDS */

.kpi-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:16px;
    margin-bottom:20px;
}

.kpi{
    background:white;
    border-radius:16px;
    padding:18px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.kpi h4{
    margin:0;
    font-size:13px;
    color:#64748b;
    font-weight:600;
    text-transform:uppercase;
}

.kpi .value{
    margin-top:8px;
    font-size:24px;
    font-weight:700;
}

.kpi.pick .value{ color:#92400e; }
.kpi.restock .value{ color:#166534; }

/* TABLE */

.card{
    background:white;
    border-radius:16px;
    padding:20px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.status{
    margin-bottom:16px;
    font-size:14px;
    color:#475569;
}

table{
    width:100%;
    border-collapse:collapse;
    font-size:14px;
}

th, td{
    padding:12px;
    border-bottom:1px solid #e2e8f0;
    text-align:left;
}

th{
    background:#f8fafc;
    font-weight:600;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.5px;
}

tr:hover{
    background:#f8fafc;
}

/* Badge */

.badge{
    padding:6px 10px;
    border-radius:20px;
    font-size:12px;
    font-weight:600;
}

.badge.pick{
    background:#fef9c3;
    color:#92400e;
}

.badge.restock{
    background:#dcfce7;
    color:#166534;
}

.row-pick{ background:#fffbeb; }
.row-restock{ background:#f0fdf4; }

</style>
</head>

<body>

<header>WMS - Admin Dashboard</header>

<div class="container">

<!-- KPI -->
<div class="kpi-grid">
    <div class="kpi">
        <h4>Movimenti Totali</h4>
        <div class="value" id="kpiTotal">0</div>
    </div>

    <div class="kpi pick">
        <h4>Pick</h4>
        <div class="value" id="kpiPick">0</div>
    </div>

    <div class="kpi restock">
        <h4>Restock</h4>
        <div class="value" id="kpiRestock">0</div>
    </div>

    <div class="kpi">
        <h4>Operatori Attivi</h4>
        <div class="value" id="kpiOperators">0</div>
    </div>
</div>

<!-- TABLE -->
<div class="card">

<div class="status" id="status">
Caricamento dati...
</div>

<table>
<thead>
<tr>
<th>Data</th>
<th>Ora</th>
<th>Operatore</th>
<th>Item</th>
<th>Operazione</th>
</tr>
</thead>
<tbody id="tableBody"></tbody>
</table>

</div>
</div>

<script>

/* =========================
   CONFIG
========================= */

const DROPBOX_APP_KEY = "k026s39y9cnq8y1";
const DROPBOX_FOLDER = "/movimenti";

/* =========================
   TOKEN STORAGE
========================= */

let accessToken = localStorage.getItem("db_access");
let refreshToken = localStorage.getItem("db_refresh");

/* =========================
   PKCE HELPERS
========================= */

function generateRandomString(length) {
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let result = "";
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

async function sha256base64url(str) {
    const encoder = new TextEncoder();
    const data = encoder.encode(str);
    const hash = await crypto.subtle.digest("SHA-256", data);
    return btoa(String.fromCharCode(...new Uint8Array(hash)))
        .replace(/\+/g, "-")
        .replace(/\//g, "_")
        .replace(/=+$/, "");
}

/* =========================
   OAUTH INIT
========================= */

async function initDropboxAuth() {

    const redirectUri = "https://evotechlab.github.io/pickappadmin/";
    const params = new URLSearchParams(window.location.search);
    const code = params.get("code");

    // RITORNO DA DROPBOX
    if (code && !accessToken) {

        const codeVerifier = sessionStorage.getItem("pkce_code_verifier");

        const response = await fetch("https://api.dropboxapi.com/oauth2/token", {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: new URLSearchParams({
                code,
                grant_type: "authorization_code",
                client_id: DROPBOX_APP_KEY,
                redirect_uri: redirectUri,
                code_verifier: codeVerifier
            })
        });

        if (!response.ok) {
            console.error("Token exchange failed");
            localStorage.clear();
            location.reload();
            return;
        }

        const data = await response.json();

        accessToken = data.access_token;
        refreshToken = data.refresh_token;

        localStorage.setItem("db_access", accessToken);
        localStorage.setItem("db_refresh", refreshToken);

        window.history.replaceState({}, document.title, redirectUri);
    }

    // SE NON AUTENTICATO
    if (!accessToken && !refreshToken) {

        const codeVerifier = generateRandomString(64);
        const codeChallenge = await sha256base64url(codeVerifier);

        sessionStorage.setItem("pkce_code_verifier", codeVerifier);

        const authUrl =
            `https://www.dropbox.com/oauth2/authorize` +
            `?client_id=${DROPBOX_APP_KEY}` +
            `&response_type=code` +
            `&token_access_type=offline` +
            `&redirect_uri=${encodeURIComponent(redirectUri)}` +
            `&code_challenge=${codeChallenge}` +
            `&code_challenge_method=S256`;

        window.location.href = authUrl;
        return;
    }
}

/* =========================
   REFRESH TOKEN
========================= */

async function refreshAccessToken() {

    const response = await fetch("https://api.dropboxapi.com/oauth2/token", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({
            grant_type: "refresh_token",
            refresh_token: refreshToken,
            client_id: DROPBOX_APP_KEY
        })
    });

    if (!response.ok) {
        console.error("Refresh failed");
        localStorage.clear();
        location.reload();
        return;
    }

    const data = await response.json();
    accessToken = data.access_token;
    localStorage.setItem("db_access", accessToken);
}

/* =========================
   DROPBOX FETCH WRAPPER
========================= */

async function dropboxFetch(url, options = {}) {

    options.headers = options.headers || {};
    options.headers["Authorization"] = "Bearer " + accessToken;

    let response = await fetch(url, options);

    if (response.status === 401 && refreshToken) {
        await refreshAccessToken();
        options.headers["Authorization"] = "Bearer " + accessToken;
        response = await fetch(url, options);
    }

    if (!response.ok) {
        throw new Error("Dropbox API error: " + response.status);
    }

    return response;
}

/* =========================
   STATE
========================= */

let loadedFiles = new Set();
let movements = [];

/* =========================
   LIST FILES
========================= */

async function listAllFiles() {

    const response = await dropboxFetch(
        "https://api.dropboxapi.com/2/files/list_folder",
        {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ path: DROPBOX_FOLDER })
        }
    );

    const data = await response.json();
    return data.entries || [];
}

/* =========================
   DOWNLOAD FILE
========================= */

async function downloadFile(path) {

    const response = await dropboxFetch(
        "https://content.dropboxapi.com/2/files/download",
        {
            method: "POST",
            headers: {
                "Dropbox-API-Arg": JSON.stringify({ path })
            }
        }
    );

    return await response.json();
}

/* =========================
   UPDATE DATA
========================= */

async function updateData() {

    document.getElementById("status").innerText = "Aggiornamento...";

    const files = await listAllFiles();

    for (const file of files) {

        if (file[".tag"] !== "file") continue;

        if (!loadedFiles.has(file.path_lower)) {

            const content = await downloadFile(file.path_lower);

            movements.push(content);
            loadedFiles.add(file.path_lower);
        }
    }

    renderDashboard();
}

/* =========================
   RENDER DASHBOARD
========================= */

function renderDashboard() {

    movements.sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp));

    let pickCount = 0;
    let restockCount = 0;
    let operatorSet = new Set();

    movements.forEach(m=>{
        const action = (m.azione || "pick").toLowerCase();
        if(action === "restock") restockCount++;
        else pickCount++;
        operatorSet.add(m.operatore);
    });

    document.getElementById("kpiTotal").innerText = movements.length;
    document.getElementById("kpiPick").innerText = pickCount;
    document.getElementById("kpiRestock").innerText = restockCount;
    document.getElementById("kpiOperators").innerText = operatorSet.size;

    renderTable();

    document.getElementById("status").innerText =
        "Ultimo aggiornamento: " + new Date().toLocaleTimeString();
}

/* =========================
   RENDER TABLE
========================= */

function renderTable(){

    const tbody = document.getElementById("tableBody");
    tbody.innerHTML = "";

    movements.forEach(m=>{

        const d = new Date(m.timestamp);
        const azione = (m.azione || "pick").toLowerCase();
        const rowClass = azione === "restock" ? "row-restock" : "row-pick";

        tbody.innerHTML += `
        <tr class="${rowClass}">
            <td>${d.toLocaleDateString()}</td>
            <td>${d.toLocaleTimeString()}</td>
            <td>${m.operatore}</td>
            <td>${m.barcode}</td>
            <td><span class="badge ${azione}">${azione.toUpperCase()}</span></td>
        </tr>`;
    });
}

/* =========================
   INIT
========================= */

async function init() {
    await initDropboxAuth();
    await updateData();
    setInterval(updateData, 5000);
}

init();

</script>



</body>
</html>
